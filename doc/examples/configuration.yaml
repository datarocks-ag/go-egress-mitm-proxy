proxy:
  port: "8080"
  metrics_port: "9090"
  default_policy: "BLOCK"   # Options: ALLOW, BLOCK
  outgoing_ca_bundle: ""    # Optional: path to PEM CA bundle for upstream TLS verification

  # Optional: PKCS#12 truststore for upstream TLS verification (additive with outgoing_ca_bundle)
  # outgoing_truststore_path: "certs/upstream-cas.p12"
  # outgoing_truststore_password: "changeit"

  # Disable upstream TLS certificate verification globally (for dev/test only!)
  # insecure_skip_verify: false

  # MITM CA certificate - provide either PEM cert+key or a PKCS#12 keystore (not both)

  # Option A: PEM files
  mitm_cert_path: "certs/ca.crt"
  mitm_key_path: "certs/ca.key"

  # Option B: PKCS#12 keystore (.p12 bundle containing cert and key)
  # mitm_keystore_path: "certs/ca.p12"
  # mitm_keystore_password: "changeit"

# Domain rewrite rules
# Supports exact match, wildcards (*.example.com), and regex (~<pattern>)
# Rewrite rules bypass ACL checks
# Each rule must specify either target_ip or target_host (not both)
rewrites:
  # Exact domain match with target IP
  - domain: "api.production.com"
    target_ip: "10.20.30.40"
    headers:
      X-Proxy-Source: "egress-gateway"
      X-Environment: "production"

  # Wildcard match (matches any subdomain depth) with target IP
  - domain: "*.internal.example.com"
    target_ip: "10.20.30.50"
    headers:
      X-Internal: "true"

  # Regex match (prefix with ~ for full regex)
  - domain: "~^api[0-9]+\\.example\\.com$"
    target_ip: "10.20.30.60"

  # Rewrite using target_host (resolved via DNS at dial time)
  - domain: "external-api.partner.com"
    target_host: "internal-gateway.corp.example.com"
    headers:
      X-Routed-Via: "egress-proxy"

  # Rewrite with insecure flag (skip TLS verification for this target only)
  - domain: "self-signed.internal.com"
    target_ip: "10.20.30.70"
    insecure: true

# Access Control Lists (exact match, wildcards, or ~regex)
# Evaluated in order: blacklist -> whitelist -> default_policy
acl:
  whitelist:
    - "*.google.com"
    - "*.googleapis.com"
    - "github.com"
    - "*.github.com"
    - "*.githubusercontent.com"
  blacklist:
    - "*.tiktok.com"
    - "*.facebook.com"
    - "*.twitter.com"
    - "~social-media\\.internal"   # regex: matches as substring
