proxy:
  port: "8080"
  metrics_port: "9090"
  default_policy: "BLOCK"   # Options: ALLOW, BLOCK
  outgoing_ca_bundle: ""    # Optional: path to PEM CA bundle for upstream TLS verification
  outgoing_ca: []           # Optional: list of individual CA cert files (can be combined with bundle)
  # outgoing_ca:
  #   - "certs/internal-ca.crt"
  #   - "certs/partner-ca.crt"

  # Optional: PKCS#12 truststore for upstream TLS verification (additive with outgoing_ca_bundle)
  # outgoing_truststore_path: "certs/upstream-cas.p12"
  # outgoing_truststore_password: "changeit"

  # Disable upstream TLS certificate verification globally (for dev/test only!)
  # insecure_skip_verify: false

  # MITM CA certificate - provide either PEM cert+key or a PKCS#12 keystore (not both)
  # Generate with: mitm-proxy gencert --type root --cn "My CA" --out-cert certs/ca.crt --out-key certs/ca.key
  # Or for intermediate CA: mitm-proxy gencert --type intermediate --signing-cert root.crt --signing-key root.key --out-chain certs/chain.crt --out-key certs/ca.key

  # Option A: PEM files (use --out-chain for intermediate CA setup)
  mitm_cert_path: "certs/ca.crt"
  mitm_key_path: "certs/ca.key"

  # Option B: PKCS#12 keystore (generate with: mitm-proxy gencert --out-p12 certs/ca.p12 --p12-password changeit)
  # mitm_keystore_path: "certs/ca.p12"
  # mitm_keystore_password: "changeit"

# Domain rewrite rules
# Supports exact match, wildcards (*.example.com), and regex (~<pattern>)
# Rewrite rules bypass ACL checks
# Each rule must specify either target_ip or target_host (not both)
rewrites:
  # Exact domain match with target IP
  - domain: "api.production.com"
    target_ip: "10.20.30.40"
    headers:
      X-Proxy-Source: "egress-gateway"
      X-Environment: "production"

  # Wildcard match (matches any subdomain depth) with target IP
  - domain: "*.internal.example.com"
    target_ip: "10.20.30.50"
    headers:
      X-Internal: "true"

  # Regex match (prefix with ~ for full regex)
  - domain: "~^api[0-9]+\\.example\\.com$"
    target_ip: "10.20.30.60"

  # Rewrite using target_host (resolved via DNS at dial time)
  - domain: "external-api.partner.com"
    target_host: "internal-gateway.corp.example.com"
    headers:
      X-Routed-Via: "egress-proxy"

  # Rewrite with insecure flag (skip TLS verification for this target only)
  - domain: "self-signed.internal.com"
    target_ip: "10.20.30.70"
    insecure: true

  # Path-based rewrites: route different URL paths on the same domain to different backends.
  # Rules are evaluated in YAML order (first match wins).
  # path_pattern is a regex matched against r.URL.Path.
  - domain: "api.example.com"
    path_pattern: "^/v1/"
    target_ip: "10.20.30.80"
    headers:
      X-Backend: "v1"

  - domain: "api.example.com"
    path_pattern: "^/v2/"
    target_ip: "10.20.30.81"
    headers:
      X-Backend: "v2"

  # Catch-all for remaining paths on the same domain (no path_pattern = matches all paths)
  - domain: "api.example.com"
    target_ip: "10.20.30.82"
    headers:
      X-Backend: "default"

  # Scheme rewrite: forward HTTPS client requests as HTTP to the backend
  - domain: "legacy-backend.internal.com"
    target_ip: "10.20.30.90"
    target_scheme: "http"
    headers:
      X-Forwarded-Proto: "https"

  # Drop headers: strip sensitive client headers before forwarding
  - domain: "sanitized-api.internal.com"
    target_ip: "10.20.30.91"
    drop_headers:
      - "Authorization"
      - "Cookie"
      - "X-Internal-Token"
    headers:
      X-Proxy-Auth: "service-account"

# Access Control Lists (exact match, wildcards, or ~regex)
# Evaluated in order: blacklist -> whitelist -> default_policy
# Passthrough entries bypass MITM entirely (tunnel without TLS interception)
acl:
  whitelist:
    - "*.google.com"
    - "*.googleapis.com"
    - "github.com"
    - "*.github.com"
    - "*.githubusercontent.com"
  blacklist:
    - "*.tiktok.com"
    - "*.facebook.com"
    - "*.twitter.com"
    - "~social-media\\.internal"   # regex: matches as substring
  passthrough:
    # Tunnel these hosts without MITM interception.
    # Use for services with their own PKI where clients don't trust the proxy CA.
    - "kubernetes.default.svc"
    - "*.vault.internal"
